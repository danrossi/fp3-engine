function PropertyBinder(){}function Fp3EngineUtils(){}function Fp3EngineEvents(e){this.engine=e,this.player=e.player,this.extend=flowplayer.extend}function Fp3Engine(e,t){if(this.common=flowplayer.common,this.bean=flowplayer.bean,this.support=flowplayer.support,this.player=e,this.root=t,this.callbackId,this.conf=e.conf,this.volumeLevel,this.callbackId,this.config={native_controls:!1},e.conf.hasOwnProperty("native_controls")&&(this.config.native_controls=e.conf.native_controls),window.flowplayer.hasOwnProperty("fireEvent")||window.flowplayer.extend(flowplayer,{fireEvent:function(){var e=[].slice.call(arguments);try{window[e[0]][e[1]](e.slice(2))}catch(t){console.log(t)}}}),this.config.native_controls){var n=e.fullscreen;e.fullscreen=function(){if("flashfp3"==this.player.engine.engineName&&this.conf.native_controls)n();else try{this.api.fp_toggleFullscreen()}catch(e){console.log(e)}}.bind(this)}}function Fp3EngineWrapper(e,t){return new Fp3Engine(e,t)}PropertyBinder.copy=function(e,t){for(var n in t)try{t[n].constructor==Object?e[n]=PropertyBinder.copy(e[n],t[n]):e[n]=t[n]}catch(i){e[n]=t[n]}return e},Fp3EngineUtils.escapeURL=function(e){return e.replace(/&amp;/g,"%26").replace(/&/g,"%26").replace(/=/g,"%3D")},Fp3EngineUtils.toHex=function(e){function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return(e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))?"#"+t(e[1])+t(e[2])+t(e[3]):void 0},Fp3EngineUtils.toLongHex=function(e){if(7===e.length)return e;var t=e.split("").slice(1);return"#"+t.map(function(e){return e+e}).join("")},Fp3EngineUtils.embed=function(e,t,n,i){n=n||"transparent";var o="obj"+(""+Math.random()).slice(2,15),r='<object class="fp-engine" id="'+o+'" name="'+o+'" ',p=navigator.userAgent.indexOf("MSIE")>-1,s=flowplayer.common;r+=p?'classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000">':' data="'+e+'" type="application/x-shockwave-flash">';var a={width:"100%",height:"100%",allowscriptaccess:"always",allowFullScreen:!0,wmode:n,quality:"high",flashvars:"",movie:e+(p?"?"+o:""),name:o};"transparent"!==n&&(a.bgcolor=i||"#333333"),a.flashvars="config="+JSON.stringify(t).replace(/\s/g," "),Object.keys(a).forEach(function(e){r+='<param name="'+e+"\" value='"+a[e]+"'/>"}),r+="</object>";var l=s.createElement("div",{},r);return s.find("object",l)},Fp3EngineEvents.prototype.onStageVideoStateChange=function(){},Fp3EngineEvents.prototype.onClipAdd=function(e){},Fp3EngineEvents.prototype.onLoad=function(){},Fp3EngineEvents.prototype.onBeforeBegin=function(){},Fp3EngineEvents.prototype.onConnect=function(){},Fp3EngineEvents.prototype.onMouseOut=function(){},Fp3EngineEvents.prototype.onMouseOver=function(){},Fp3EngineEvents.prototype.onBeforePluginEvent=function(){},Fp3EngineEvents.prototype.onPluginEvent=function(){},Fp3EngineEvents.prototype.onResized=function(){},Fp3EngineEvents.prototype.onMetaDataChange=function(){},Fp3EngineEvents.prototype.triggerEvent=function(e,t){var n={type:e};setTimeout(function(){this.player.trigger(n,[this.player,t])}.bind(this),1)},Fp3EngineEvents.prototype.onMetaData=function(e){var t=this.extend(this.player.video,e[1]);this.triggerEvent("ready",t)},Fp3EngineEvents.prototype.onStart=function(){this.triggerEvent("resume")},Fp3EngineEvents.prototype.onBegin=function(){},Fp3EngineEvents.prototype.onBufferFull=function(){this.player.video.buffered=!0,this.triggerEvent("buffered")},Fp3EngineEvents.prototype.onBeforePause=function(){},Fp3EngineEvents.prototype.onPause=function(){this.triggerEvent("pause"),this.engine.clearProgress()},Fp3EngineEvents.prototype.onBeforeResume=function(){},Fp3EngineEvents.prototype.onResume=function(){this.triggerEvent("resume"),this.engine.startProgress()},Fp3EngineEvents.prototype.onBeforeSeek=function(){this.triggerEvent("beforeseek")},Fp3EngineEvents.prototype.onSeek=function(e){var t=e[1];this.player.video.time=t,this.triggerEvent("seek",t)},Fp3EngineEvents.prototype.onBeforeVolume=function(){},Fp3EngineEvents.prototype.onVolume=function(e){var t=e[0]/100;this.triggerEvent("volume",t)},Fp3EngineEvents.prototype.onFullscreen=function(){this.player.fullscreen=!0},Fp3EngineEvents.prototype.onFullscreenExit=function(){this.player.fullscreen=!1},Fp3EngineEvents.prototype.onBeforeFullscreen=function(){},Fp3EngineEvents.prototype.onBeforeUnmute=function(){},Fp3EngineEvents.prototype.onUnmute=function(){},Fp3EngineEvents.prototype.onBeforeMute=function(){},Fp3EngineEvents.prototype.onMute=function(){},Fp3EngineEvents.prototype.onBeforeStop=function(){},Fp3EngineEvents.prototype.onStop=function(){},Fp3EngineEvents.prototype.onPlaylistReplace=function(){},Fp3Engine.prototype.pick=function(e){if(flowplayer.support.flashVideo){for(var t,n,i=0;i<e.length;i++)if(n=e[i],/mp4|flv|flash|widevine/i.test(n.type)&&(t=n),t&&!/mp4/i.test(t.type))return t;return t}},Fp3Engine.prototype.load=function(e){var t=this.common,n=t.find("video",this.root)[0],i=Fp3EngineUtils.escapeURL(e.src),o=/^https?:/.test(i),r=function(){t.removeNode(n)},p=function(e){return e.some(function(e){return!!n.canPlayType(e.type)})};flowplayer.support.video&&t.prop(n,"autoplay")&&p(e.sources)?bean.one(n,"timeupdate",r):r();var s=e.rtmp||this.conf.rtmp,a=!o&&s;if(a||(i=t.createAbsoluteUrl(i)),this.api){if(this.conf.playlist.length)return void this.api.fp_play(e.index);var l={url:i,autoPlay:!0};PropertyBinder.copy(l,e),this.api.fp_play(l)}else{this.player.on("mute",function(e,t,n){n?this.api.fp_mute():this.api.fp_unmute()}.bind(this)),this.callbackId="fpCallback"+(""+Math.random()).slice(3,15);var f={clip:{url:i,autoPlay:this.player.conf.autoplay,autoBuffering:!this.player.conf.autoplay,accelerated:"direct"==this.player.conf.wmode},plugins:{},playerId:this.callbackId};if(this.config.native_controls){var c=t.find(".fp-player",this.root)[0];t.css(c,"display","none"),this.player.one("ready",function(){t.removeClass(this.root,"is-poster")}.bind(this))}else f.plugins.controls=null,f.play=null;if(this.conf.playlist.length){var u=[];this.conf.playlist.forEach(function(e){var t=this.conf.playlist[e].sources,n={url:this.pick(t).src};this.conf.playlist[e].flash&&this.extend(n,this.conf.playlist[e].flash),u.push(n)}),f.playlist=u}PropertyBinder.copy(f,this.conf.flash),void 0!==this.conf.bufferTime&&(f.bufferTime=this.conf.bufferTime),a&&(f.clip.provider="rtmp",f.clip.netConnectionUrl=this.conf.rtmp);var h,g=t.css(this.root,"background-color")||"";if(0===g.indexOf("rgb")?h=Fp3EngineUtils.toHex(g):0===g.indexOf("#")&&(h=Fp3EngineUtils.toLongHex(g)),this.api=Fp3EngineUtils.embed(this.conf.swf,f,this.conf.wmode,h)[0],this.config.native_controls)t.prepend(this.root,this.api);else{var y=t.find(".fp-player",this.root)[0];t.prepend(y,this.api)}this.checkLoaded(),this.clearProgress(),this.player.conf.autoplay&&this.startProgress();var d=new Fp3EngineEvents(this);window[this.callbackId]=d}},Fp3Engine.prototype.checkLoaded=function(){setTimeout(function(){try{if(!this.api.PercentLoaded())return this.player.trigger("error",[this.player,{code:7,url:conf.swf}])}catch(e){}}.bind(this),5e3),setTimeout(function(){"undefined"==typeof this.api.PercentLoaded&&this.player.trigger("flashdisabled",[this.player])}.bind(this),1e3)},Fp3Engine.prototype.startProgress=function(){this.api.pollInterval=setInterval(this.updateProgress.bind(this),250)},Fp3Engine.prototype.clearProgress=function(){clearInterval(this.api.pollInterval)},Fp3Engine.prototype.updateProgress=function(){if(this.api){var e=this.api.fp_getStatus(),t=this.player.video;e&&(this.player.playing&&e.time&&e.time!==this.player.video.time&&this.triggerEvent("progress",e.time),t.buffer=e.buffer/t.bytes*t.duration,this.triggerEvent("buffer",t.buffer),!t.buffered&&e.time>0&&(t.buffered=!0,this.triggerEvent("buffered")))}},Fp3Engine.prototype.pause=function(){this.callMethod("pause")},Fp3Engine.prototype.resume=function(){this.callMethod("resume")},Fp3Engine.prototype.speed=flowplayer.common.noop,Fp3Engine.prototype.seek=function(e){this.player.video.time&&!this.player.paused&&this.player.trigger("beforeseek"),this.callMethod("seek",e)},Fp3Engine.prototype.volume=function(e){this.volumeLevel=e;try{this.api.fp_setVolume(100*e)}catch(t){}},Fp3Engine.prototype.callMethod=function(e,t){try{this.player.ready&&(void 0===t?this.api["fp_"+e]():this.api["fp_"+e](t))}catch(n){if("undefined"==typeof this.api["fp_"+e])return this.player.trigger("flashdisabled",[this.player]);throw n}},Fp3Engine.prototype.unload=function(){this.api&&this.api.__unload&&this.api.__unload(),this.callbackId&&window[this.callbackId]&&delete window[this.callbackId],this.common.find("object",this.root).forEach(this.common.removeNode),this.api=0,this.player.off(".flashengine"),this.clearProgress()},Fp3Engine.prototype.triggerEvent=function(e,t){this.player.trigger(e,[this.player,t])};var fp3Engine=Fp3EngineWrapper;fp3Engine.engineName="flashfp3",fp3Engine.canPlay=function(e,t){return flowplayer.support.flashVideo&&/video\/(mp4|flash|flv)/i.test(e)||flowplayer.support.flashVideo&&t.swfWidevine&&/widevine/i.test(e)},flowplayer.engines.unshift(fp3Engine);
